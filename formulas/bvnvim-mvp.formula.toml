# bvnvim MVP — Cross-Rig Orchestration Formula
#
# Coordinates the bvnvim plugin build across four rigs + Dolt:
#   1. hq (Dolt)      — Formula DB schema + migration (poured first)
#   2. sfgastown       — gt formula Dolt backend (Go code)
#   3. bvnvim          — Neovim plugin (Lua + Python)
#   4. nvim_config     — LazyVim registration
#
# Dependencies:
#   bv rig (beads_viewer) — must be running with --dolt support.
#   Consumed as a dependency, no code changes expected.
#   Dolt server at 127.0.0.1:3307 — must be running.
#
# Integration branches:
#   sfgastown:   integration/formula-dolt-backend
#   bvnvim:      integration/bvnvim-mvp
#   nvim_config: integration/bvnvim-registration
#
# Sequencing:
#   DB first → sfgastown + bvnvim in parallel → nvim_config → verify
#
# Usage:
#   gt cook bvnvim-mvp
#   gt cook bvnvim-mvp --var skip_migration=true   # if DB already poured

description = """
Cross-rig orchestration for the bvnvim Neovim plugin MVP.

Builds a Neovim plugin that operates on three content planes — agent session
transcripts, Dolt-stored formulas, and materialized beads — with wizard mode
for AI-driven visual editing via Neovim's RPC API.

## What Gets Built

| Rig | Deliverable |
|-----|-------------|
| hq (Dolt) | 12 formula tables (DNA + execution tracking), 52 TOMLs migrated |
| sfgastown | `gt formula` reads/writes Dolt, `gt formula sync`, execution recording |
| bvnvim | Full Lua plugin: data layers, buffer rendering, telescope pickers, wizard mode |
| nvim_config | LazyVim registration with keymaps |

## Dependencies (must be running, not built)

- **bv** (beads_viewer) — `bv --robot-*` JSON API and `--dolt` flag consumed by bvnvim
- **Dolt server** — 127.0.0.1:3307, hosts hq + per-rig databases
- **bd** — beads CLI for CRUD operations
- **pynvim** — Python RPC client for wizard driver (already installed)

## Audit Trail

Every action versioned at four levels:
- Dolt: formula definitions + beads (branching, diffable)
- Git: code changes on integration branches
- Neovim undo tree: per-keystroke edit history (persistent undofile)
- Session JSONL: full agent-to-human conversation logs
"""
formula = "bvnvim-mvp"
type = "workflow"
version = 1

[vars]
[vars.skip_migration]
description = "Set to 'true' to skip Dolt schema creation + TOML migration (if already done)"
required = false
default = ""

[vars.plan_path]
description = "Path to the design plan document"
required = false
default = "~/gt/bvnvim/mayor/rig/docs/plan.md"

# ============================================================================
# STEP 1: VERIFY INFRASTRUCTURE
# ============================================================================

[[steps]]
id = "verify-infra"
title = "Verify infrastructure dependencies are running"
description = """
Check that all required services and tools are available before starting.

```bash
# Dolt server
dolt --host 127.0.0.1 --port 3307 --user root --password "" --no-tls sql \
    -q "SELECT 1;" || { echo "FATAL: Dolt server not running"; exit 1; }

# bv with --dolt support
bv --version || { echo "FATAL: bv not found"; exit 1; }
bv --dolt --robot-triage --format json 2>/dev/null | head -1 || \
    echo "WARN: bv --dolt may not be working"

# bd CLI
bd --version || { echo "FATAL: bd not found"; exit 1; }

# pynvim
python3 -c "import pynvim; print(f'pynvim {pynvim.__version__}')" || \
    { echo "FATAL: pynvim not installed"; exit 1; }

# Rigs exist
gt rig list | grep -q bvnvim || { echo "FATAL: bvnvim rig missing"; exit 1; }
gt rig list | grep -q sfgastown || { echo "FATAL: sfgastown rig missing"; exit 1; }
gt rig list | grep -q nvim_config || { echo "FATAL: nvim_config rig missing"; exit 1; }

echo "All infrastructure checks passed"
```
"""

# ============================================================================
# STEP 2: POUR FORMULA DB (hq Dolt)
# ============================================================================

[[steps]]
id = "pour-formula-db"
title = "Create formula tables in hq Dolt database and migrate 52 existing TOMLs"
needs = ["verify-infra"]
description = """
Create the normalized formula schema (12 tables) in the hq database on a Dolt
branch, import all 52 existing formula TOML files, then merge to main.

Skip if `{{skip_migration}}` is set to 'true'.

**Tables created (Phase 1 — DNA):**
- `formulas` (with raw_toml)
- `formula_steps`, `formula_step_deps`
- `formula_vars`
- `formula_units` (legs + aspects)
- `formula_prompts`
- `formula_output`, `formula_synthesis`, `formula_synthesis_deps`
- `formula_rig_targets`

**Tables created (Phase 2 — Cooked & Poured):**
- `formula_runs`
- `formula_run_items`

**Migration:**
- Parse each `~/gt/.beads/formulas/*.formula.toml`
- Normalize into all tables (steps, deps, vars, units, etc.)
- Preserve `raw_toml` for round-trip editing
- Verify row counts match expected

**Dolt workflow:**
1. `CALL DOLT_BRANCH('formula-schema')` on hq
2. Create all tables + INSERT migrated data
3. `CALL DOLT_COMMIT(...)` on the branch
4. Review: `dolt diff main..formula-schema`
5. `CALL DOLT_MERGE('formula-schema')` to main

**Memory note:** Dolt operations are lightweight (~50MB). Safe to run alongside other work.
"""

# ============================================================================
# STEP 3: SFGASTOWN — FORMULA DOLT BACKEND
# ============================================================================

[[steps]]
id = "sfgastown-formula-backend"
title = "Teach gt formula to read/write Dolt (sfgastown Go changes)"
needs = ["pour-formula-db"]
description = """
Add Dolt loading/writing to the `gt formula` command in sfgastown.

**Integration branch:** `integration/formula-dolt-backend`

**Changes:**

1. `internal/formula/dolt_loader.go` (new) — Dolt SQL backend for formula loading
   - `LoadFromDolt(name)` → queries all formula tables, returns Formula struct
   - `ListFromDolt()` → SELECT from formulas table
   - `SaveToDolt(formula)` → normalize and write to all tables + commit
   - Falls back to filesystem if Dolt unavailable

2. `internal/formula/parser.go` (modify) — add Dolt as primary source
   - `ParseFile()` tries Dolt first, falls back to filesystem
   - New `ParseFromDolt(name)` function

3. `internal/cmd/formula.go` (modify)
   - `gt formula list` reads from Dolt
   - `gt formula show` reads from Dolt
   - `gt formula run` records execution in `formula_runs` + `formula_run_items`
   - New: `gt formula sync` — exports Dolt → filesystem cache

4. `internal/formula/embed.go` (modify)
   - `ProvisionFormulas()` seeds Dolt on install (in addition to filesystem)
   - `CheckFormulaHealth()` checks Dolt state

**Memory note:** Go compilation ~1-2GB. Coordinate builds, don't run alongside other cargo/go builds.
"""

# ============================================================================
# STEP 4: BVNVIM — PLUGIN SKELETON + DATA LAYERS
# ============================================================================

[[steps]]
id = "bvnvim-skeleton"
title = "Build bvnvim plugin skeleton with data layers for all three content planes"
needs = ["pour-formula-db"]
parallel = true
description = """
Create the core bvnvim Neovim plugin: setup, config, and data modules for
beads, formulas, and sessions.

**Integration branch:** `integration/bvnvim-mvp`

**Files created:**
- `lua/bvnvim/init.lua` — setup(), commands, state
- `lua/bvnvim/config.lua` — defaults, validation
- `lua/bvnvim/data/beads.lua` — bd CLI wrapper (list, show, update, close, create)
- `lua/bvnvim/data/analysis.lua` — bv CLI wrapper (triage, plan, insights, search)
- `lua/bvnvim/data/formulas.lua` — Dolt SQL loader for formulas (all 12 tables)
- `lua/bvnvim/data/sessions.lua` — Session JSONL parser (MVP: list + extract)

**Commands registered:**
- `:Beads list/show/refresh` — materialized beads
- `:Beads formula [name]` — formula browser
- `:Beads session [uuid]` — session transcript
- `:Beads wizard start|stop` — wizard mode
- `:Beads triage <rig>` — triage diff view
- `:Beads formula runs/diff` — formula execution history

**Session exploration tasks** (part of this step):
1. Map full JSONL schema (all entry types)
2. Correlate sessions → rigs → beads
3. Design transcript rendering format

**Memory note:** Pure Lua, no compilation. Lightweight.
"""

# ============================================================================
# STEP 5: BVNVIM — BUFFER RENDERING + HIGHLIGHTS
# ============================================================================

[[steps]]
id = "bvnvim-buffers"
title = "Build buffer rendering for all three content planes"
needs = ["bvnvim-skeleton"]
description = """
Create the buffer rendering modules for beads, formulas, sessions, and triage.

**Integration branch:** `integration/bvnvim-mvp` (continues from skeleton)

**Files created:**
- `lua/bvnvim/buffer/beads_list.lua` — fixed-column table with priority colors
- `lua/bvnvim/buffer/beads_detail.lua` — structured header + markdown, acwrite for bd
- `lua/bvnvim/buffer/formula.lua` — TOML editing with step graph, acwrite for Dolt
- `lua/bvnvim/buffer/session.lua` — read-only markdown transcript with folds
- `lua/bvnvim/buffer/triage_diff.lua` — proposal accept/reject view
- `lua/bvnvim/highlight.lua` — all highlight groups (priority, status, human/agent/tool)

**URI schemes:**
- `bead://<id>` — individual bead detail
- `formula://<name>` — formula TOML from Dolt
- `formula-runs://<name>` — execution history
- `session://<uuid>` — conversation transcript

**Memory note:** Pure Lua, no compilation. Lightweight.
"""

# ============================================================================
# STEP 6: BVNVIM — ACTIONS + TELESCOPE + WIZARD
# ============================================================================

[[steps]]
id = "bvnvim-interactive"
title = "Build actions, telescope pickers, and wizard mode"
needs = ["bvnvim-buffers"]
description = """
Add interactivity: keymaps, write-back actions, telescope integration, wizard mode.

**Integration branch:** `integration/bvnvim-mvp` (continues)

**Files created:**
- `lua/bvnvim/actions.lua` — status/priority changes, triage accept/merge
- `lua/telescope/_extensions/bvnvim.lua` — three picker modes (beads, formulas, sessions)
- `lua/bvnvim/wizard.lua` — wizard mode state, RPC handler, sequencer
- `scripts/wizard_driver.py` — external Python RPC wizard driver

**Telescope pickers:**
1. Beads — fuzzy search ID + title + assignee, colored columns
2. Formulas — name/type/version/steps + last run status
3. Sessions — date/project/rig/size

**Wizard modes:**
- Visual (`:norm` + delays) — cursor animation, human watches
- Fast (`nvim_buf_set_text`) — instant batch updates

**Memory note:** pynvim is pure Python, lightweight. Telescope is already installed.
"""

# ============================================================================
# STEP 7: NVIM_CONFIG — LAZYVIM REGISTRATION
# ============================================================================

[[steps]]
id = "nvim-registration"
title = "Register bvnvim plugin in LazyVim config"
needs = ["bvnvim-interactive"]
description = """
Create the LazyVim plugin spec in nvim_config rig.

**Integration branch:** `integration/bvnvim-registration`

**File created:**
- `lua/plugins/bvnvim.lua`

```lua
return {
  {
    dir = "/home/ubuntu/gt/bvnvim/mayor/rig",
    dependencies = { "nvim-lua/plenary.nvim", "nvim-telescope/telescope.nvim" },
    config = function()
      require("bvnvim").setup({})
    end,
    keys = {
      { "<leader>bb", "<cmd>Beads list<cr>", desc = "Beads list" },
      { "<leader>bs", "<cmd>Telescope bvnvim beads<cr>", desc = "Beads search" },
      { "<leader>bf", "<cmd>Telescope bvnvim formulas<cr>", desc = "Formula picker" },
      { "<leader>bh", "<cmd>Telescope bvnvim sessions<cr>", desc = "Session history" },
      { "<leader>bt", "<cmd>Beads triage<cr>", desc = "Triage view" },
      { "<leader>bw", "<cmd>Beads wizard start<cr>", desc = "Wizard mode" },
    },
  },
}
```

**Memory note:** One file, trivial.
"""

# ============================================================================
# STEP 8: INTEGRATION VERIFICATION
# ============================================================================

[[steps]]
id = "verify-integration"
title = "End-to-end verification across all rigs"
needs = ["sfgastown-formula-backend", "nvim-registration"]
description = """
Verify everything works together across all four rigs.

**Checks:**

Plane 1 — Sessions:
- `:Beads session` lists available sessions
- `:Telescope bvnvim sessions` finds sessions by date/project
- Opening a session shows formatted transcript with folds

Plane 2 — Formulas:
- `:Beads formula` lists formulas from Dolt (not filesystem)
- `:Telescope bvnvim formulas` shows formulas with last run status
- Open a formula → TOML with step graph overlay
- `:w` saves to Dolt + commits + updates filesystem cache
- `gt formula list` reads from Dolt
- `gt formula sync` exports Dolt → filesystem

Plane 3 — Beads:
- `:Beads list` shows formatted table with colors
- `<CR>` opens detail, `s` changes status via bd
- `:Beads triage sfgastown` opens triage proposals
- Accept proposals → merge works

Cross-plane:
- `:Beads wizard start` → Python driver connects → cursor animation works
- `u` undoes wizard edits
- `:UndotreeToggle` shows full edit DAG

Infrastructure:
- bv --robot-* commands return valid JSON (dependency check)
- Dolt formula tables have 52 rows
- Integration branches merge cleanly to main

**After verification:** Merge all integration branches to main.
"""

# ============================================================================
# SQUASH
# ============================================================================

[squash]
trigger = "on_complete"
template_type = "patrol"
include_metrics = true
